<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MacMarket</title>
    <style>
        body { margin:0; font-family: Arial, Helvetica, sans-serif; }
        header { background:#222; color:#fff; padding:10px; display:flex; align-items:center; justify-content:center; }
        header h1 { margin:0; font-size:1.5em; }
        #sidebar { position:fixed; left:0; top:0; bottom:0; width:180px; background:#222; color:#fff; padding-top:60px; }
        #sidebar a { color:#fff; display:block; padding:10px; text-decoration:none; }
        #sidebar a:hover { background:#444; }
        main { margin-left:180px; }
        #time { position:absolute; top:10px; right:10px; color:#fff; font-size:0.9em; }
        #ticker-bar { background:#333; color:#fff; overflow:hidden; white-space:nowrap; padding:5px; position:relative; }
        #ticker-track { display:inline-block; white-space:nowrap; padding-left:100%; animation: ticker-scroll 30s linear infinite; }
        @keyframes ticker-scroll {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }
        .ticker-item { display:inline-block; margin-right:20px; }
        .up { color:#0f0; }
        .down { color:#f00; }
        #news { padding:20px; display:flex; gap:20px; }
        .news-col { flex:1; }
        #charts {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            padding: 20px;
        }
        #charts canvas {
            flex: 1 1 calc(50% - 20px);
            max-width: calc(50% - 20px);
            height: 200px;
        }
        #chart-controls { padding:0 20px; }
    </style>
</head>
<body onload="init();">
<div id="sidebar">
    <a href="index.html">Home</a>
    <a href="login.html">Login</a>
    <a href="account.html">Account</a>
    <a href="tickers.html">Tickers</a>
    <a href="admin.html" id="admin-link" style="display:none;">Admin</a>
</div>
<header>
    <h1>MacMarket</h1>
    <div id="time"></div>
</header>
<main>
<div id="ticker-bar"><div id="ticker-track"></div></div>
<div id="chart-controls">Time range:
    <select id="range-select">
        <option value="1mo">1M</option>
        <option value="3mo">3M</option>
        <option value="6mo">6M</option>
        <option value="1y">1Y</option>
    </select>
</div>
<div id="charts"></div>
<section id="news">
    <div id="market-news" class="news-col"></div>
    <div id="world-news" class="news-col"></div>
</section>
</main>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
    let userId = null;
    let tickerSymbols = ['AAPL','MSFT','GOOGL','AMZN','TSLA','SPY','QQQ','GLD','BTC-USD','ETH-USD'];
    let chartSymbols = [];
    const charts = {};

function updateTime() {
    const now = new Date();
    document.getElementById('time').textContent = now.toLocaleString();
}

async function loadTicker() {
    if(userId){
        const resp = await fetch(`/api/users/${userId}/tickers`);
        if(resp.ok){
            const data = await resp.json();
            if(data.tickers && data.tickers.length){
                tickerSymbols = data.tickers;
            }
        }
    }
    chartSymbols = tickerSymbols.slice(0, 4);
    const res = await fetch('/api/ticker?symbols=' + tickerSymbols.join(','));
    const data = await res.json();
    const track = document.getElementById('ticker-track');
    track.innerHTML = '';
    data.data.forEach(item => {
        const span = document.createElement('span');
        const cls = item.change_percent >= 0 ? 'up' : 'down';
        span.className = 'ticker-item ' + cls;
        if(item.price === null) {
            span.textContent = `${item.symbol} N/A`;
        } else {
            span.textContent = `${item.symbol} ${item.price.toFixed(2)} (${item.change_percent.toFixed(2)}%)`;
        }
        track.appendChild(span);
    });
    track.innerHTML += track.innerHTML; // duplicate for smooth scroll
}
async function loadNews() {
    const res = await fetch('/api/news');
    const data = await res.json();
    const marketDiv = document.getElementById('market-news');
    const worldDiv = document.getElementById('world-news');
    marketDiv.innerHTML = '<h2>Market News</h2>';
    worldDiv.innerHTML = '<h2>World News</h2>';
    const addList = (div, articles) => {
        const ul = document.createElement('ul');
        articles.forEach(a => {
            const li = document.createElement('li');
            const link = document.createElement('a');
            link.href = a.url;
            link.textContent = a.title;
            link.target = '_blank';
            li.appendChild(link);
            ul.appendChild(li);
        });
        div.appendChild(ul);
    };
    addList(marketDiv, data.market || []);
    addList(worldDiv, data.world || []);
}

async function loadCharts(){
    const period = document.getElementById('range-select').value;
    for(let i = 0; i < chartSymbols.length; i++){
        const symbol = chartSymbols[i];
        const res = await fetch(`/api/history?symbol=${symbol}&period=${period}`);
        const data = await res.json();
        const canvasId = `chart-${i}`;
        const ctx = document.getElementById(canvasId).getContext('2d');
        if(charts[canvasId]) charts[canvasId].destroy();
        charts[canvasId] = new Chart(ctx, {
            type: 'line',
            data: { labels: data.dates, datasets: [{ label: symbol, data: data.close, borderColor: '#3e95cd', fill:false }] },
            options: { responsive:true, maintainAspectRatio:false, animation:false, scales:{ x:{ display:false } } }
        });
    }
}

function setupCharts(){
    const div = document.getElementById('charts');
    div.innerHTML = '';
    chartSymbols.forEach((sym, idx) => {
        const canvas = document.createElement('canvas');
        canvas.id = `chart-${idx}`;
        div.appendChild(canvas);
    });
}

async function init() {
    updateTime();
    setInterval(updateTime, 1000);
    userId = localStorage.getItem('userId');
    if(localStorage.getItem('isAdmin') === '1'){
        document.getElementById('admin-link').style.display='block';
    }
    await loadTicker();
    setupCharts();
    await loadCharts();
    loadNews();
    document.getElementById('range-select').addEventListener('change', loadCharts);
}
</script>
</body>
</html>
