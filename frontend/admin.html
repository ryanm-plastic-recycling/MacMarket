<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin - MacMarket</title>
    <link rel="stylesheet" href="style.css">
    <script src="theme.js"></script>
</head>
<body>
<div id="sidebar">
    <a href="index.html">Home</a>
    <a href="login.html">Login</a>
    <a href="account.html">Account</a>
    <a href="tickers.html">Tickers</a>
    <a href="signals.html">Signals</a>
    <a href="journal.html">Journal</a>
    <a href="admin.html">Admin</a>
    <a href="help.html#admin">Help</a>
    <a href="#" id="logout-link">Logout</a>
    <select id="theme-select">
        <option value="light">Light</option>
        <option value="dark">Dark</option>
    </select>
</div>
<header>
    <h1>MacMarket</h1>
    <div id="user-info"></div>
    <div id="time"></div>
</header>
<main>
    <h2>User Management</h2>
    <table id="users"><thead><tr><th>Username</th><th>Email</th><th>OTP</th><th>Admin</th><th>Last Login</th><th>New Password</th><th>Actions</th></tr></thead><tbody></tbody></table>
</main>
<script>
    if(localStorage.getItem('isAdmin') !== '1') {
        window.location.href = 'account.html';
    }
    async function loadUsers(){
        const res = await fetch('/api/admin/users');
        if(!res.ok) return;
        const data = await res.json();
        const tbody = document.querySelector('#users tbody');
        tbody.innerHTML='';
        data.users.forEach(u => {
            const tr = document.createElement('tr');
            tr.innerHTML =
                `<td><input type="text" class="username" value="${u.username}" data-id="${u.id}"></td>`+
                `<td><input type="email" class="email" value="${u.email||''}" data-id="${u.id}"></td>`+
                `<td><input type="checkbox" class="otp-flag" ${u.otp_enabled?'checked':''} data-id="${u.id}"></td>`+
                `<td><input type="checkbox" class="admin-flag" ${u.is_admin?'checked':''} data-id="${u.id}"></td>`+
                `<td>${u.last_logged_in||''}</td>`+
                `<td><input type="password" class="pw" data-id="${u.id}"></td>`+
                `<td><button class="save" data-id="${u.id}">Save</button></td>`;
            tbody.appendChild(tr);
        });
    }
    document.addEventListener('click', async e => {
        if(e.target.className === 'save'){
            const id = e.target.dataset.id;
            const row = e.target.closest('tr');
            const pw = row.querySelector('.pw').value;
            const admin = row.querySelector('.admin-flag').checked;
            const username = row.querySelector('.username').value.trim();
            const email = row.querySelector('.email').value.trim();
            const otp = row.querySelector('.otp-flag').checked;
            if(pw){
                await fetch(`/api/admin/users/${id}/password`, {method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({password: pw})});
            }
            await fetch(`/api/admin/users/${id}/admin?is_admin=${admin}`, {method:'PUT'});
            await fetch(`/api/admin/users/${id}/username`, {method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({username})});
            if(email){
                await fetch(`/api/admin/users/${id}/email`, {method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({email})});
            }
            await fetch(`/api/admin/users/${id}/otp`, {method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({otp_enabled: otp})});
            alert('Saved');
        }
    });
    window.onload = loadUsers;
</script>
</body>
</html>
